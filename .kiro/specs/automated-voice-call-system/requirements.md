# 要件定義書

## 概要

電話番号を収集し、自動音声通話（IVR）を通じてユーザーに質問を行い、回答を収集・保存するシステムです。収集したデータに基づいてフォローアップを行う機能も含みます。

## 要件

### 要件 1: Supabaseデータ監視機能

**ユーザーストーリー:** システム管理者として、外部システムがSupabaseに格納した電話番号データを自動的に検知し、即座に発信処理を開始したいので、リアルタイムデータ監視機能が必要

#### 受入基準

1. WHEN 外部システムがSupabaseに新しい電話番号を格納 THEN システムはリアルタイムでデータ変更を検知し、即座に自動発信処理をトリガーする
2. WHEN 新規電話番号データが検知された THEN システムは該当レコードを取得し、バリデーション後に発信キューに追加する
3. WHEN Supabaseの接続に問題が発生 THEN システムはエラーログを記録し、自動再接続を試行する
4. WHEN 電話番号データが更新された THEN システムは変更内容を検証し、必要に応じて発信スケジュールを調整する
5. WHEN システム起動時 THEN システムはSupabaseから未処理の電話番号データを取得し、即座に発信処理を開始する

### 要件 2: 自動発信機能

**ユーザーストーリー:** システム管理者として、電話番号が回収され次第即座に自動発信を実行したいので、リアルタイム発信トリガー機能が必要

#### 受入基準

1. WHEN 新しい電話番号がSupabaseに格納された THEN システムは即座に該当電話番号への発信を開始する
2. WHEN 手動発信トリガーが実行された THEN システムは指定された電話番号に即座に発信する
3. WHEN 発信が開始された THEN システムは該当レコードのステータスを「発信中」に更新し、発信開始時刻を記録する
4. IF 発信に失敗した THEN システムはエラーログを記録し、設定された間隔で再試行スケジュールを設定する
5. WHEN 同時発信数が上限に達した THEN システムは新規発信を発信キューに追加し、順次処理する

### 要件 3: 動的IVRシナリオ設計機能

**ユーザーストーリー:** システム管理者として、収集したい項目に応じてIVRの質問内容を柔軟に設定したいので、シナリオを動的に設計・管理できる機能が必要

#### 受入基準

1. WHEN 管理画面でIVRシナリオを作成 THEN システムは質問項目、回答選択肢、分岐条件を設定できる
2. WHEN シナリオに新しい質問項目を追加 THEN システムは質問文、回答形式（DTMF/音声録音）、必須/任意を設定できる
3. WHEN 回答選択肢を設定 THEN システムは各選択肢に対応する番号とラベルを定義できる
4. WHEN シナリオの分岐条件を設定 THEN システムは回答内容に応じた次の質問への遷移ルールを定義できる
5. WHEN シナリオを保存 THEN システムはバリデーションを行い、論理的な矛盾がないことを確認する

### 要件 4: 動的IVR音声フロー実行機能

**ユーザーストーリー:** 見込み客として、自動音声通話を受けた際に、設定されたシナリオに従って明確で分かりやすい質問に回答したい

#### 受入基準

1. WHEN 通話が接続された THEN システムは設定されたシナリオの最初の質問を再生する
2. WHEN ユーザーがDTMF入力で回答 THEN システムは回答を記録し、シナリオに従って次の質問に遷移する
3. WHEN ユーザーが音声で回答 THEN システムは音声を録音し、設定された時間制限内で録音を終了する
4. WHEN 分岐条件に該当する回答 THEN システムは設定されたルールに従って適切な次の質問に遷移する
5. WHEN 全ての質問が完了 THEN システムは終了メッセージを再生し、通話を終了する

### 要件 5: 項目別回答データSupabase保存機能

**ユーザーストーリー:** 営業担当者として、IVRで収集した回答データを項目ごとに構造化してSupabaseに保存し、後で分析・活用したい

#### 受入基準

1. WHEN IVRフローで各質問項目の回答が収集された THEN システムは項目IDと回答内容を対応付けてSupabaseに保存する
2. WHEN DTMF回答が取得された THEN システムは選択番号と対応するラベル値をSupabaseの該当項目カラムに保存する
3. WHEN 音声録音データが取得された THEN システムは音声ファイルをSupabase Storageに保存し、ファイルURLを該当項目に記録する
4. WHEN 通話が完了した THEN システムは全回答データを電話番号と紐付けてSupabaseのresponsesテーブルに保存する
5. IF Supabaseへの保存に失敗した THEN システムはローカルにバックアップを作成し、再試行スケジュールを設定する

### 要件 6: SMS通知・フォローアップ機能

**ユーザーストーリー:** 営業担当者として、IVRで情報が回収され次第即座に通知を受け取り、適切なフォローアップを行いたいので、SMS通知機能が必要

#### 受入基準

1. WHEN IVR通話が完了し情報が回収された THEN システムは営業担当者の電話番号宛にSMSで通知を送信する
2. WHEN SMS通知を送信 THEN システムは電話番号、回答内容の要約、通話完了時刻を含める
3. WHEN ユーザーが「興味あり」かつフォロー希望日時を指定 THEN システムはSMS通知に優先度フラグを付けて送信する
4. WHEN 特定のプランが選択された THEN システムは該当プランの担当者にアサイン情報を含むSMS通知を送信する
5. IF SMS送信に失敗した THEN システムはエラーログを記録し、再送スケジュールを設定する
6. WHEN フォロー希望日時が近づいた THEN システムはリマインダーSMSを営業担当者に送信する

### 要件 7: 管理画面機能

**ユーザーストーリー:** システム管理者として、IVRシナリオ設計、発信状況、回答データを統合的に管理したいので、包括的な管理画面が必要

#### 受入基準

1. WHEN 管理画面にアクセス THEN システムはダッシュボードで発信状況、回答収集状況、エラー状況を表示する
2. WHEN IVRシナリオ管理画面を開く THEN システムは既存シナリオ一覧と新規作成・編集機能を提供する
3. WHEN 回答データ一覧を表示 THEN システムは電話番号、各項目の回答内容、日時を項目別に表形式で表示する
4. WHEN 手動発信ボタンをクリック THEN システムは選択された電話番号に設定されたシナリオで即座に発信を開始する
5. WHEN Supabaseデータとの同期状況を確認 THEN システムは最新の同期日時と同期エラーがあれば詳細を表示する

### 要件 8: セキュリティ・認証機能

**ユーザーストーリー:** システム管理者として、機密性の高い顧客データを扱うため、適切な認証とアクセス制御が必要

#### 受入基準

1. WHEN 管理画面にアクセス THEN システムは認証を要求し、未認証ユーザーはアクセスを拒否する
2. WHEN 電話番号データにアクセス THEN システムは適切な権限を持つユーザーのみアクセスを許可する
3. WHEN データベース接続 THEN システムは暗号化された接続を使用する
4. WHEN 音声データを保存 THEN システムは適切な暗号化を適用する